name: Scraping Diario de Propiedades

on:
  schedule:
    # Se ejecuta a las 12:00 UTC (09:00 AM hora Argentina/Uruguay UTC-3)
    - cron: '0 12 * * *'
  # Permite ejecutarlo manualmente desde la pestaÃ±a "Actions" de GitHub
  workflow_dispatch:

jobs:
  scrape-and-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Permiso necesario para guardar la DB actualizada en el repo

    steps:
    - name: ğŸ“¥ Checkout del cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ Configurar Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: ğŸ“¦ Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    - name: ğŸ•·ï¸ Ejecutar Spiders
      run: |
        # LIMPIEZA TOTAL: Borramos la DB para empezar de cero cada dÃ­a
        # AsÃ­ garantizamos que no haya "fantasmas" de casas ya alquiladas.
        rm -f propiedades.db
        touch propiedades.db
        
        echo "Iniciando scraping desde cero..."
        
        # Lista de spiders a ejecutar
        spiders=("zonaprop" "argenprop" "remax" "mapropiedades" "lacapital" "bienesrosario")
        
        for spider in "${spiders[@]}"; do
            echo "â–¶ Ejecutando spider: $spider"
            # Usamos || true para que si un spider falla, no detenga a los demÃ¡s
            scrapy crawl "$spider" -L INFO || true
            sleep 2
        done

    - name: ğŸ“Š Verificar Base de Datos
      run: |
        if [ -f propiedades.db ]; then
            echo "Base de datos encontrada. TamaÃ±o:"
            ls -lh propiedades.db
        else
            echo "::error::No se generÃ³ la base de datos propiedades.db"
            exit 1
        fi

    - name: ğŸ’¾ Guardar cambios en el repositorio
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "ğŸ¤– Auto-update: Base de datos de propiedades actualizada"
        file_pattern: 'propiedades.db'
        commit_user_name: "GitHub Actions Bot"
        commit_user_email: "actions@github.com"
